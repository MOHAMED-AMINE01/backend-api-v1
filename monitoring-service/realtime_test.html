<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IOT Real-Time Dashboard</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --primary: #38bdf8;
            --secondary: #818cf8;
            --text: #f1f5f9;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: radial-gradient(circle at top right, #1e293b, #0f172a);
            color: var(--text);
            margin: 0;
            padding: 2rem;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
        }

        .status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-online {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .status-offline {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7);
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(74, 222, 128, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0);
            }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .device-id {
            font-size: 0.75rem;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .device-name {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 1rem 0;
            background: linear-gradient(to right, #fff, var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .mini-metric {
            background: rgba(255, 255, 255, 0.05);
            padding: 0.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .label {
            font-size: 0.7rem;
            color: #94a3b8;
            margin-bottom: 0.25rem;
        }

        .val {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .time {
            font-size: 0.7rem;
            color: #64748b;
            margin-top: 1rem;
            text-align: right;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div>
                <h1 style="margin:0; font-size: 2rem;">Système de Monitoring</h1>
                <p style="color: #64748b; margin: 0.5rem 0 0 0;">Données transmises par RabbitMQ via Socket.IO</p>
            </div>
            <div id="connection-status" class="status status-offline">
                <div class="pulse"></div>
                <span>Déconnecté</span>
            </div>
        </header>

        <div id="device-grid" class="grid">
            <!-- Les cartes d'appareils apparaîtront ici -->
        </div>
    </div>

    <script>
        const socket = io('http://172.26.80.134', {
            path: '/monitoring/socket.io',
            transports: ['websocket'],
            withCredentials: true
        });
        const statusDiv = document.getElementById('connection-status');
        const grid = document.getElementById('device-grid');
        const devices = {};

        socket.on('connect', () => {
            statusDiv.className = 'status status-online';
            statusDiv.innerHTML = '<div class="pulse"></div><span>Connecté au Serveur</span>';
            console.log('Connecté au serveur Socket.IO');
        });

        socket.on('disconnect', () => {
            statusDiv.className = 'status status-offline';
            statusDiv.innerHTML = '<span>Déconnecté</span>';
        });

        socket.on('new_metric', (rawData) => {
            const metric = typeof rawData === 'string' ? JSON.parse(rawData) : rawData;
            console.log('Nouvelle donnée reçue:', metric);
            updateDeviceCard(metric);
        });

        function updateDeviceCard(metric) {
            const id = metric.device_id;
            const data = metric.data;
            let card = document.getElementById(`device-${id}`);

            if (!card) {
                card = document.createElement('div');
                card.id = `device-${id}`;
                card.className = 'card';
                grid.appendChild(card);
            }

            let content = `
    <div class="device-id">ID: ${id} • ${metric.topic.replace('device/', '').replace('/', ' > ')}</div>
    <div class="device-name">${data.name || 'Appareil Inconnu'}</div>
    `;

            if (data.metrics) {
                // Format End Device (CPU, RAM...)
                content += `
    <div class="metrics-grid">
        <div class="mini-metric">
            <div class="label">CPU</div>
            <div class="val">${data.metrics.cpu}%</div>
        </div>
        <div class="mini-metric">
            <div class="label">RAM</div>
            <div class="val">${data.metrics.ram}%</div>
        </div>
        <div class="mini-metric">
            <div class="label">Stockage</div>
            <div class="val">${data.metrics.storage}%</div>
        </div>
    </div>
    `;
            } else {
                // Format IOT (Temp, Hum...)
                content += `
    <div class="metric-value">${data.value} <span style="font-size: 1.5rem">${data.unit}</span></div>
    `;
            }

            content += `<div class="time">Dernière mise à jour: ${new Date().toLocaleTimeString()}</div>`;
            card.innerHTML = content;
        }
    </script>
</body>

</html>